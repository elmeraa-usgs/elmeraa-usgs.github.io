{
  "hash": "d186d1603180009ffc4d8eb4a1a4216f",
  "result": {
    "markdown": "---\ntitle: \"Plotting changes in streamflow: 1995 to 2025\"\ndescription: |\n  Create a stripe plot of daily mean discharge anomalies at the Potomac River, MD\nauthor:\n  - name: Elmera Azadpour\ndate: 2026-01-15\nformat: html\ncategories: [code, streamflow, tables, visualization]\nimage: \"streamflow-anomaly-fig.png\"\n---\n\n\n### About\n\nAn anomaly can be defined as something that deviates from what is standard, normal, or expected. Here, I will demo how to plot daily mean streamflow anomolies (from the annual mean) over time at the Potomac River at Point of Rocks, MD ([USGS-01638500](https://waterdata.usgs.gov/monitoring-location/USGS-01638500/#dataTypeId=continuous-00065-0&period=P7D&showFieldMeasurements=true)).\n\n### Load packages\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse) # for wrangling data frames\nlibrary(dataRetrieval) # for loading streamflow data\nlibrary(sf) # for wrangling spatial features\nlibrary(mapview) # for interactive map view\nlibrary(showtext) # for custom font loading\nlibrary(sysfonts) # for custom font loading\nlibrary(scales) # for custom breaks/labels on legend \nlibrary(scico) # for color palette \nlibrary(cowplot) # for composing final plot \n```\n:::\n\n\n### Set global variables\n\nHere we will set some variables that can be easily adjusted downstream, for ease. User's can load custom fonts from Google Fonts (for example, \"Cousine\" can be found [here](https://fonts.google.com/specimen/Cousine)). You may also want to select a different USGS streamgage to plot streamflow data. In this case, I selected [USGS-01638500](https://waterdata.usgs.gov/monitoring-location/USGS-01638500/#dataTypeId=continuous-00065-0&period=P7D&showFieldMeasurements=true) due to it's long streamflow/discharge record.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load custom font\nfont_text <- \"Cousine\"\nsysfonts::font_add_google(font_text)\nshowtext_opts(dpi = 300, regular.wt = 200, bold.wt = 700)\nshowtext::showtext_auto()\n\nusgs_site_no <- \"USGS-01638500\"\n# https://help.waterdata.usgs.gov/code/parameter_cd_query?fmt=rdb&inline=true&group_cd=%\nparameter_id <- \"00060\" # discharge, cubic feet per second\n# https://help.waterdata.usgs.gov/code/stat_cd_nm_query?stat_nm_cd=%25&fmt=html\nstat_id <- \"00003\" # mean values\nstart_date <- \"1995-01-01\"\nend_date <- \"2025-12-31\"\n\nbg_color <- \"white\"\nscico_palette <- \"roma\"\nleg_text <- \"Percent from annual mean\"\ntitle_text <- \"Daily mean discharge anomalies\\nPotomac River at Point of Rocks, MD\\nUSGS 01638500\"\ntag_text <- \"Data: WDFN | Elmera Azadpour\"\n```\n:::\n\n\n### Load daily discharge data\n\nWe will use the *new* `dataRetrieval::read_waterdata_daily()` function with more information about the function [here](https://water.code-pages.usgs.gov/dataRetrieval/reference/read_waterdata_daily.html).\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndv <- read_waterdata_daily(\n  monitoring_location_id = usgs_site_no,\n  parameter_code = parameter_id, \n  statistic_id = stat_id,\n  time = c(start_date, end_date),\n  skipGeometry = FALSE\n)\n\nhead(dv, n = 5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nSimple feature collection with 5 features and 11 fields\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: -77.54311 ymin: 39.27358 xmax: -77.54311 ymax: 39.27358\nGeodetic CRS:  WGS 84\n# A tibble: 5 × 12\n  daily_id     time_series_id monitoring_location_id parameter_code statistic_id\n  <chr>        <chr>          <chr>                  <chr>          <chr>       \n1 66d15e47-9c… 6fce477b41084… USGS-01638500          00060          00003       \n2 4cdd0b93-5b… 6fce477b41084… USGS-01638500          00060          00003       \n3 77a5160d-ca… 6fce477b41084… USGS-01638500          00060          00003       \n4 a516866d-5f… 6fce477b41084… USGS-01638500          00060          00003       \n5 befbfc9d-65… 6fce477b41084… USGS-01638500          00060          00003       \n# ℹ 7 more variables: time <date>, value <dbl>, unit_of_measure <chr>,\n#   approval_status <chr>, last_modified <dttm>, qualifier <chr>,\n#   geometry <POINT [°]>\n```\n:::\n:::\n\n### View gage\n\nUsing [mapview](https://github.com/r-spatial/mapview), you can take a gander at the location of the streamgage on the Potomac River, Maryland. \n\n::: {.cell}\n\n```{.r .cell-code}\nmapview(slice_head(dv, n = 1))\n```\n\n::: {.cell-output-display}\n```{=html}\n<div class=\"leaflet html-widget html-fill-item\" id=\"htmlwidget-7f3db315ab8e7b307c0e\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-7f3db315ab8e7b307c0e\">{\"x\":{\"options\":{\"minZoom\":1,\"maxZoom\":52,\"crs\":{\"crsClass\":\"L.CRS.EPSG3857\",\"code\":null,\"proj4def\":null,\"projectedBounds\":null,\"options\":{}},\"preferCanvas\":false,\"bounceAtZoomLimits\":false,\"maxBounds\":[[[-90,-370]],[[90,370]]]},\"calls\":[{\"method\":\"addProviderTiles\",\"args\":[\"CartoDB.Positron\",\"CartoDB.Positron\",\"CartoDB.Positron\",{\"errorTileUrl\":\"\",\"noWrap\":false,\"detectRetina\":false,\"pane\":\"tilePane\"}]},{\"method\":\"addProviderTiles\",\"args\":[\"CartoDB.DarkMatter\",\"CartoDB.DarkMatter\",\"CartoDB.DarkMatter\",{\"errorTileUrl\":\"\",\"noWrap\":false,\"detectRetina\":false,\"pane\":\"tilePane\"}]},{\"method\":\"addProviderTiles\",\"args\":[\"OpenStreetMap\",\"OpenStreetMap\",\"OpenStreetMap\",{\"errorTileUrl\":\"\",\"noWrap\":false,\"detectRetina\":false,\"pane\":\"tilePane\"}]},{\"method\":\"addProviderTiles\",\"args\":[\"Esri.WorldImagery\",\"Esri.WorldImagery\",\"Esri.WorldImagery\",{\"errorTileUrl\":\"\",\"noWrap\":false,\"detectRetina\":false,\"pane\":\"tilePane\"}]},{\"method\":\"addProviderTiles\",\"args\":[\"OpenTopoMap\",\"OpenTopoMap\",\"OpenTopoMap\",{\"errorTileUrl\":\"\",\"noWrap\":false,\"detectRetina\":false,\"pane\":\"tilePane\"}]},{\"method\":\"createMapPane\",\"args\":[\"point\",440]},{\"method\":\"addCircleMarkers\",\"args\":[39.27358333333333,-77.5431111111111,6,null,\"slice_head(dv, n = 1)\",{\"crs\":{\"crsClass\":\"L.CRS.EPSG3857\",\"code\":null,\"proj4def\":null,\"projectedBounds\":null,\"options\":{}},\"pane\":\"point\",\"stroke\":true,\"color\":\"#333333\",\"weight\":1,\"opacity\":0.9,\"fill\":true,\"fillColor\":\"#6666FF\",\"fillOpacity\":0.6},null,null,\"<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\\/td><th><b>Feature ID&emsp;<\\/b><\\/th><td>1&emsp;<\\/td><\\/tr><tr><td>1<\\/td><th>daily_id&emsp;<\\/th><td>66d15e47-9c2c-4565-9818-3ee83d35c5dc&emsp;<\\/td><\\/tr><tr><td>2<\\/td><th>time_series_id&emsp;<\\/th><td>6fce477b4108481d950866411cdc1c00&emsp;<\\/td><\\/tr><tr><td>3<\\/td><th>monitoring_location_id&emsp;<\\/th><td>USGS-01638500&emsp;<\\/td><\\/tr><tr><td>4<\\/td><th>parameter_code&emsp;<\\/th><td>00060&emsp;<\\/td><\\/tr><tr><td>5<\\/td><th>statistic_id&emsp;<\\/th><td>00003&emsp;<\\/td><\\/tr><tr><td>6<\\/td><th>time&emsp;<\\/th><td>1995-01-01&emsp;<\\/td><\\/tr><tr><td>7<\\/td><th>value&emsp;<\\/th><td>4180&emsp;<\\/td><\\/tr><tr><td>8<\\/td><th>unit_of_measure&emsp;<\\/th><td>ft^3/s&emsp;<\\/td><\\/tr><tr><td>9<\\/td><th>approval_status&emsp;<\\/th><td>Approved&emsp;<\\/td><\\/tr><tr><td>10<\\/td><th>last_modified&emsp;<\\/th><td>2025-02-21 13:01:18&emsp;<\\/td><\\/tr><tr><td>11<\\/td><th>qualifier&emsp;<\\/th><td>&emsp;<\\/td><\\/tr><tr><td>12<\\/td><th>geometry&emsp;<\\/th><td>sfc_POINT&emsp;<\\/td><\\/tr><\\/table><\\/div>\",{\"maxWidth\":800,\"minWidth\":50,\"autoPan\":true,\"keepInView\":false,\"closeButton\":true,\"closeOnClick\":true,\"className\":\"\"},\"1\",{\"interactive\":false,\"permanent\":false,\"direction\":\"auto\",\"opacity\":1,\"offset\":[0,0],\"textsize\":\"10px\",\"textOnly\":false,\"className\":\"\",\"sticky\":true},null]},{\"method\":\"addScaleBar\",\"args\":[{\"maxWidth\":100,\"metric\":true,\"imperial\":true,\"updateWhenIdle\":true,\"position\":\"bottomleft\"}]},{\"method\":\"addHomeButton\",\"args\":[-77.5431111111111,39.27358333333333,-77.5431111111111,39.27358333333333,true,\"slice_head(dv, n = 1)\",\"Zoom to slice_head(dv, n = 1)\",\"<strong> slice_head(dv, n = 1) <\\/strong>\",\"bottomright\"]},{\"method\":\"addLayersControl\",\"args\":[[\"CartoDB.Positron\",\"CartoDB.DarkMatter\",\"OpenStreetMap\",\"Esri.WorldImagery\",\"OpenTopoMap\"],\"slice_head(dv, n = 1)\",{\"collapsed\":true,\"autoZIndex\":true,\"position\":\"topleft\"}]},{\"method\":\"addLegend\",\"args\":[{\"colors\":[\"#6666FF\"],\"labels\":[\"slice_head(dv, n = 1)\"],\"na_color\":null,\"na_label\":\"NA\",\"opacity\":1,\"position\":\"topright\",\"type\":\"factor\",\"title\":\"\",\"extra\":null,\"layerId\":null,\"className\":\"info legend\",\"group\":\"slice_head(dv, n = 1)\"}]}],\"limits\":{\"lat\":[39.27358333333333,39.27358333333333],\"lng\":[-77.5431111111111,-77.5431111111111]},\"setView\":[[39.27358333333333,-77.5431111111111],18,[]]},\"evals\":[],\"jsHooks\":{\"render\":[{\"code\":\"function(el, x, data) {\\n  return (\\n      function(el, x, data) {\\n      // get the leaflet map\\n      var map = this; //HTMLWidgets.find('#' + el.id);\\n      // we need a new div element because we have to handle\\n      // the mouseover output separately\\n      // debugger;\\n      function addElement () {\\n      // generate new div Element\\n      var newDiv = $(document.createElement('div'));\\n      // append at end of leaflet htmlwidget container\\n      $(el).append(newDiv);\\n      //provide ID and style\\n      newDiv.addClass('lnlt');\\n      newDiv.css({\\n      'position': 'relative',\\n      'bottomleft':  '0px',\\n      'background-color': 'rgba(255, 255, 255, 0.7)',\\n      'box-shadow': '0 0 2px #bbb',\\n      'background-clip': 'padding-box',\\n      'margin': '0',\\n      'padding-left': '5px',\\n      'color': '#333',\\n      'font': '9px/1.5 \\\"Helvetica Neue\\\", Arial, Helvetica, sans-serif',\\n      'z-index': '700',\\n      });\\n      return newDiv;\\n      }\\n\\n\\n      // check for already existing lnlt class to not duplicate\\n      var lnlt = $(el).find('.lnlt');\\n\\n      if(!lnlt.length) {\\n      lnlt = addElement();\\n\\n      // grab the special div we generated in the beginning\\n      // and put the mousmove output there\\n\\n      map.on('mousemove', function (e) {\\n      if (e.originalEvent.ctrlKey) {\\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\\n      lnlt.text(\\n                           ' lon: ' + (e.latlng.lng).toFixed(5) +\\n                           ' | lat: ' + (e.latlng.lat).toFixed(5) +\\n                           ' | zoom: ' + map.getZoom() +\\n                           ' | x: ' + L.CRS.EPSG3857.project(e.latlng).x.toFixed(0) +\\n                           ' | y: ' + L.CRS.EPSG3857.project(e.latlng).y.toFixed(0) +\\n                           ' | epsg: 3857 ' +\\n                           ' | proj4: +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs ');\\n      } else {\\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\\n      lnlt.text(\\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\\n                      ' | zoom: ' + map.getZoom() + ' ');\\n      }\\n      });\\n\\n      // remove the lnlt div when mouse leaves map\\n      map.on('mouseout', function (e) {\\n      var strip = document.querySelector('.lnlt');\\n      if( strip !==null) strip.remove();\\n      });\\n\\n      };\\n\\n      //$(el).keypress(67, function(e) {\\n      map.on('preclick', function(e) {\\n      if (e.originalEvent.ctrlKey) {\\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\\n      lnlt.text(\\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\\n                      ' | zoom: ' + map.getZoom() + ' ');\\n      var txt = document.querySelector('.lnlt').textContent;\\n      console.log(txt);\\n      //txt.innerText.focus();\\n      //txt.select();\\n      setClipboardText('\\\"' + txt + '\\\"');\\n      }\\n      });\\n\\n      }\\n      ).call(this.getMap(), el, x, data);\\n}\",\"data\":null},{\"code\":\"function(el, x, data) {\\n  return (function(el,x,data){\\n           var map = this;\\n\\n           map.on('keypress', function(e) {\\n               console.log(e.originalEvent.code);\\n               var key = e.originalEvent.code;\\n               if (key === 'KeyE') {\\n                   var bb = this.getBounds();\\n                   var txt = JSON.stringify(bb);\\n                   console.log(txt);\\n\\n                   setClipboardText('\\\\'' + txt + '\\\\'');\\n               }\\n           })\\n        }).call(this.getMap(), el, x, data);\\n}\",\"data\":null}]}}</script>\n```\n:::\n:::\n\n\n### Prepare daily anomalies within each year\n\nTo quantify changes from typical conditions, daily discharge values are converted to percent anomalies relative to each year’s mean. This normalizes variability across wet and dry years while preserving seasonal patterns.\n\n::: {.cell}\n\n```{.r .cell-code}\ndv_proc <- dv |> \n  st_drop_geometry() |> \n  mutate(\n    date = as.Date(time),\n    year = year(date),\n    value = as.numeric(value)\n  ) |> \n  group_by(year) |> \n  mutate(\n    annual_mean = mean(value, na.rm = TRUE),\n    pct_from_annual_mean = 100 * (value - annual_mean) / annual_mean\n  ) |> \n  ungroup()\n```\n:::\n\n\n### Create stripe plot\n\nBelow we'll make a stripe plot where each row represents a year and each column a day of the year, with color indicating the magnitude and direction of the discharge anomaly. This stripe style layout highlights seasonality, extremes, and longterm shifts in streamflow at a glance.\n\n::: {.cell}\n\n```{.r .cell-code}\nbase_plot <- ggplot(\n  dv_proc,\n  aes(x = yday(date),\n      y = factor(year),\n      fill = pct_from_annual_mean)\n  ) +\n  geom_tile(height = 1) +\n  # Provide custom legend breaks/lables \n  scale_x_continuous(\n    breaks = c(1, 91, 182, 274, 365),\n    labels = c(\"Jan\", \"Apr\", \"Jul\", \"Oct\", \"Dec\"),\n    expand = c(0, 0)\n  ) +\n  scale_fill_scico(\n    palette = scico_palette,\n    direction = 1,\n    limits = c(-100, 100),\n    breaks = c(-100, -50, 0, 50, 100),\n    # Add % label on 0% anomaly legend element\n    labels = function(x) ifelse(x == 0, \"0%\", as.character(x)),\n    oob = squish,\n    # Supply our legend title \n    name = leg_text,\n    alpha = 0.9,\n    guide = guide_colorbar(\n      # Set a horizontal legend to adjust downstream\n      direction = \"horizontal\",\n      ticks = TRUE,\n      barwidth = unit(2.5, \"cm\"),\n      barheight = unit(0.15, \"cm\"),\n      label.position = \"bottom\",\n      title.position = \"top\",\n      title.hjust = 1)\n    ) +\n  # Drop title and axis text, we will add custom one downstream\n  labs(\n    title = NULL,\n    x = NULL,\n    y = NULL\n    ) +\n  # Customize theme elements\n  theme_minimal(base_size = 12) +\n  theme(panel.grid = element_blank(),\n    axis.text.x = element_text(size = 8),\n    axis.text.y = element_text(size = 6),\n    text = element_text(family = font_text),\n    legend.text = element_text(size = 6),\n    legend.title = element_text(size = 6)\n    )\n\n# Checkout viz \nbase_plot\n```\n\n::: {.cell-output-display}\n![](flow-anomaly_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n### Function to grab legend grob\n\nSince the final figure is assembled with [`cowplot`](https://cran.r-project.org/web/packages/cowplot/vignettes/introduction.html), the legend will need to be extracted from the `ggplot` object. This helper function safely returns the first nonempty legend grob for manual placement downstream.\n\n::: {.cell}\n\n```{.r .cell-code}\n#' Get legend (and avoid returning zeroGrob objects)\n#'\n#' @param plot a ggplot\n#'\n#' @return a grob with \"guide-box\" component name (i.e., a legend)\n#'\nget_legend_non0 <- function(plot) {\n  legends <- cowplot::get_plot_component(plot, \"guide-box\", return_all = TRUE)\n  non0_idx <- which(!purrr::map_lgl(legends, ~ inherits(., what = \"zeroGrob\")))\n  \n  if (length(non0_idx) == 0) {\n    cli::cli_warn(c(\"!\" = \"No non-zeroGrob legends. Returning `NULL`.\"))\n    return(NULL)\n  }\n  \n  if (length(non0_idx) > 1) {\n    cli::cli_warn(c(\"!\" = \"Multiple legends exist. Returning the first one.\"))\n  }\n  \n  legends[non0_idx][[1]]\n}\n```\n:::\n\n\n### Compose final plot\n\nWe can now combine the elements on a custom canvas using `cowplot`, allowing nice control over layout, text, and legend placement. The final plot is then exported using `ggsave()`.\n\n::: {.cell}\n\n```{.r .cell-code}\n# Pull legend \nlegend_anomoly <- get_legend_non0(base_plot)\n\n# Set background canvas \ncanvas <- grid::rectGrob(\n  x = 0, y = 0,\n  width = 16, height = 9,\n  gp = grid::gpar(\n    fill = bg_color, alpha = 1,\n    col = bg_color\n  )\n)\n\n# Cowplot elements together\np <- ggdraw(xlim = c(0, 1), ylim = c(0, 1)) +\n  draw_grob(canvas,\n            x = 0, y = 1,\n            height = 1, width = 1,\n            hjust = 0, vjust = 1\n            ) +\n  # Place base figure we made above, but drop legend\n  draw_plot(base_plot + theme(legend.position = \"none\"),\n            x = 0.05,\n            y = 0.02,\n            width  = 0.88,\n            height = 0.89\n            )  +\n  # Add our legend grob in our favored placement\n  draw_plot(legend_anomoly,\n            x = 0.8,\n            y = 0.9,\n            height = 0.08,\n            width = 0.05\n            ) +\n  # Add title text\n  draw_label(title_text,\n            x = 0.05, y = 0.945,\n            fontfamily = font_text,\n            size = 7,\n            hjust = 0\n            ) +\n  # Add citation and author text \n  draw_label(tag_text,\n             x = 0.75, y = 0.02,\n             fontfamily = font_text,\n             size = 4,\n             hjust = 0\n  )\n\n# To save   \nggsave(\n  filename = \"streamflow-anomaly-fig.png\",\n  plot = p,\n  width = 4, height = 5,\n  dpi = 300, bg = \"#FAF9F6\"\n)\n```\n:::\n\n\n![](streamflow-anomaly-fig.png)\n",
    "supporting": [
      "flow-anomaly_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/htmltools-fill-0.5.8.1/fill.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<script src=\"../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js\"></script>\n<link href=\"../../site_libs/leaflet-1.3.1/leaflet.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/leaflet-1.3.1/leaflet.js\"></script>\n<link href=\"../../site_libs/leafletfix-1.0.0/leafletfix.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/proj4-2.6.2/proj4.min.js\"></script>\n<script src=\"../../site_libs/Proj4Leaflet-1.0.1/proj4leaflet.js\"></script>\n<link href=\"../../site_libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/leaflet-binding-2.2.2/leaflet.js\"></script>\n<script src=\"../../site_libs/leaflet-providers-2.0.0/leaflet-providers_2.0.0.js\"></script>\n<script src=\"../../site_libs/leaflet-providers-plugin-2.2.2/leaflet-providers-plugin.js\"></script>\n<link href=\"../../site_libs/HomeButton-0.0.1/home-button.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/HomeButton-0.0.1/home-button.js\"></script>\n<script src=\"../../site_libs/HomeButton-0.0.1/easy-button-src.min.js\"></script>\n<script src=\"../../site_libs/clipboard-0.0.1/setClipboardText.js\"></script>\n<link href=\"../../site_libs/mapviewCSS-0.0.1/mapview-popup.css\" rel=\"stylesheet\" />\n<link href=\"../../site_libs/mapviewCSS-0.0.1/mapview.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}