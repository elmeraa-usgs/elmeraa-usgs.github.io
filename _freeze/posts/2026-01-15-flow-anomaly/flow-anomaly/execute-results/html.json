{
  "hash": "a635cecd50b0078f5e87065a68422130",
  "result": {
    "markdown": "---\ntitle: \"Plotting changes in streamflow: 1995 to 2025\"\ndescription: |\n  Create a stripe plot of daily mean discharge anomalies at the Potomac River, MD\nauthor:\n  - name: Elmera Azadpour\ndate: 2026-01-15\nformat: html\ncategories: [code, streamflow, tables, visualization]\nimage: \"streamflow-anomaly-fig.png\"\n---\n\n\n### About\n\nAn anomaly can be defined as something that deviates from what is standard, normal, or expected. Here, I will demo how to plot daily mean streamflow anomolies (from the annual mean) over time at the Potomac River at Point of Rocks, MD ([USGS-01638500](https://waterdata.usgs.gov/monitoring-location/USGS-01638500/#dataTypeId=continuous-00065-0&period=P7D&showFieldMeasurements=true)).\n\n### Load packages\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse) # for wrangling data frames\nlibrary(showtext) # for custom font loading\nlibrary(sysfonts) # for custom font loading\nlibrary(dataRetrieval) # for loading streamflow data\nlibrary(scales) # for custom breaks/labels on legend \nlibrary(scico) # for color palette \nlibrary(janitor) # for data cleaning \nlibrary(sf) # for wrangling spatial features\nlibrary(tigris) # for loading states data \nlibrary(rmapshaper) # for simplifying spatial features\nlibrary(cowplot) # for composing final plot \n```\n:::\n\n\n### Set global variables\n\nHere we will set some variables that can be easily adjusted downstream, for ease. User's can load custom fonts from Google Fonts (for example, \"Cousine\" can be found [here](https://fonts.google.com/specimen/Cousine)). You may also want to select a different USGS streamgage to plot streamflow data. In this case, I selected [USGS-01638500](https://waterdata.usgs.gov/monitoring-location/USGS-01638500/#dataTypeId=continuous-00065-0&period=P7D&showFieldMeasurements=true) due to it's long streamflow/discharge record.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load custom font\nfont_text <- \"Cousine\"\nsysfonts::font_add_google(font_text)\nshowtext_opts(dpi = 300, regular.wt = 200, bold.wt = 700)\nshowtext::showtext_auto()\n\nusgs_site_no <- \"USGS-01638500\"\n# https://help.waterdata.usgs.gov/code/parameter_cd_query?fmt=rdb&inline=true&group_cd=%\nparameter_id <- \"00060\" # discharge, cubic feet per second\n# https://help.waterdata.usgs.gov/code/stat_cd_nm_query?stat_nm_cd=%25&fmt=html\nstat_id <- \"00003\" # mean values\nstart_date <- \"1995-01-01\"\nend_date <- \"2025-12-31\"\n\nbg_color <- \"white\"\nscico_palette <- \"roma\"\nleg_text <- \"Percent from annual mean\"\ntitle_text <- \"Daily mean discharge anomalies\\nPotomac River at Point of Rocks, MD\\nUSGS 01638500\"\ntag_text <- \"Data: WDFN | Elmera Azadpour\"\n```\n:::\n\n\n### Load daily discharge data\n\nWe will use the *new* `dataRetrieval::read_waterdata_daily()` function with more information about the function [here](https://water.code-pages.usgs.gov/dataRetrieval/reference/read_waterdata_daily.html).\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndv <- read_waterdata_daily(\n  monitoring_location_id = usgs_site_no,\n  parameter_code = parameter_id, \n  statistic_id = stat_id,\n  time = c(start_date, end_date),\n  skipGeometry = TRUE\n)\n\nhead(dv, n = 5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 5 × 11\n  daily_id     time_series_id monitoring_location_id parameter_code statistic_id\n  <chr>        <chr>          <chr>                  <chr>          <chr>       \n1 66d15e47-9c… 6fce477b41084… USGS-01638500          00060          00003       \n2 4cdd0b93-5b… 6fce477b41084… USGS-01638500          00060          00003       \n3 77a5160d-ca… 6fce477b41084… USGS-01638500          00060          00003       \n4 a516866d-5f… 6fce477b41084… USGS-01638500          00060          00003       \n5 befbfc9d-65… 6fce477b41084… USGS-01638500          00060          00003       \n# ℹ 6 more variables: time <date>, value <dbl>, unit_of_measure <chr>,\n#   approval_status <chr>, last_modified <dttm>, qualifier <chr>\n```\n:::\n:::\n\n\n### Prepare daily anomalies within each year\nTo quantify changes from typical conditions, daily discharge values are converted to percent anomalies relative to each year’s mean. This normalizes variability across wet and dry years while preserving seasonal patterns.\n\n::: {.cell}\n\n```{.r .cell-code}\ndv_proc <- dv |> \n  mutate(\n    date = as.Date(time),\n    year = year(date),\n    value = as.numeric(value)\n  ) |> \n  group_by(year) |> \n  mutate(\n    annual_mean = mean(value, na.rm = TRUE),\n    pct_from_annual_mean = 100 * (value - annual_mean) / annual_mean\n  ) |> \n  ungroup()\n```\n:::\n\n\n### Create stripe plot\nBelow we'll make a stripe plot where each row represents a year and each column a day of the year, with color indicating the magnitude and direction of the discharge anomaly. This stripe style layout highlights seasonality, extremes, and longterm shifts in streamflow at a glance.\n\n::: {.cell}\n\n```{.r .cell-code}\nbase_plot <- ggplot(\n  dv_proc,\n  aes(x = yday(date),\n      y = factor(year),\n      fill = pct_from_annual_mean)\n  ) +\n  geom_tile(height = 1) +\n  # Provide custom legend breaks/lables \n  scale_x_continuous(\n    breaks = c(1, 91, 182, 274, 365),\n    labels = c(\"Jan\", \"Apr\", \"Jul\", \"Oct\", \"Dec\"),\n    expand = c(0, 0)\n  ) +\n  scale_fill_scico(\n    palette = scico_palette,\n    direction = 1,\n    limits = c(-100, 100),\n    breaks = c(-100, -50, 0, 50, 100),\n    # Add % label on 0% anomaly legend element\n    labels = function(x) ifelse(x == 0, \"0%\", as.character(x)),\n    oob = squish,\n    # Supply our legend title \n    name = leg_text,\n    alpha = 0.9,\n    guide = guide_colorbar(\n      # Set a horizontal legend to adjust downstream\n      direction = \"horizontal\",\n      ticks = TRUE,\n      barwidth = unit(2.5, \"cm\"),\n      barheight = unit(0.15, \"cm\"),\n      label.position = \"bottom\",\n      title.position = \"top\",\n      title.hjust = 1)\n    ) +\n  # Drop title and axis text, we will add custom one downstream\n  labs(\n    title = NULL,\n    x = NULL,\n    y = NULL\n    ) +\n  # Customize theme elements\n  theme_minimal(base_size = 12) +\n  theme(panel.grid = element_blank(),\n    axis.text.x = element_text(size = 8),\n    axis.text.y = element_text(size = 6),\n    text = element_text(family = font_text),\n    legend.text = element_text(size = 6),\n    legend.title = element_text(size = 6)\n    )\n\n# Checkout viz \nbase_plot\n```\n\n::: {.cell-output-display}\n![](flow-anomaly_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n### Function to grab legend grob\nSince the final figure is assembled with [`cowplot`](https://cran.r-project.org/web/packages/cowplot/vignettes/introduction.html), the legend will need to be extracted from the `ggplot` object. This helper function safely returns the first nonempty legend grob for manual placement downstream.\n\n::: {.cell}\n\n```{.r .cell-code}\n#' Get legend (and avoid returning zeroGrob objects)\n#'\n#' @param plot a ggplot\n#'\n#' @return a grob with \"guide-box\" component name (i.e., a legend)\n#'\nget_legend_non0 <- function(plot) {\n  legends <- cowplot::get_plot_component(plot, \"guide-box\", return_all = TRUE)\n  non0_idx <- which(!purrr::map_lgl(legends, ~ inherits(., what = \"zeroGrob\")))\n  \n  if (length(non0_idx) == 0) {\n    cli::cli_warn(c(\"!\" = \"No non-zeroGrob legends. Returning `NULL`.\"))\n    return(NULL)\n  }\n  \n  if (length(non0_idx) > 1) {\n    cli::cli_warn(c(\"!\" = \"Multiple legends exist. Returning the first one.\"))\n  }\n  \n  legends[non0_idx][[1]]\n}\n```\n:::\n\n\n### Compose final plot\nWe can now combine the elements on a custom canvas using `cowplot`, allowing nice control over layout, text, and legend placement. The final plot is then exported using `ggsave()`.\n\n::: {.cell}\n\n```{.r .cell-code}\n# Pull legend \nlegend_anomoly <- get_legend_non0(base_plot)\n\n# Set background canvas \ncanvas <- grid::rectGrob(\n  x = 0, y = 0,\n  width = 16, height = 9,\n  gp = grid::gpar(\n    fill = bg_color, alpha = 1,\n    col = bg_color\n  )\n)\n\n# Cowplot elements together\np <- ggdraw(xlim = c(0, 1), ylim = c(0, 1)) +\n  draw_grob(canvas,\n            x = 0, y = 1,\n            height = 1, width = 1,\n            hjust = 0, vjust = 1\n            ) +\n  # Place base figure we made above, but drop legend\n  draw_plot(base_plot + theme(legend.position = \"none\"),\n            x = 0.05,\n            y = 0.02,\n            width  = 0.88,\n            height = 0.89\n            )  +\n  # Add our legend grob in our favored placement\n  draw_plot(legend_anomoly,\n            x = 0.8,\n            y = 0.9,\n            height = 0.08,\n            width = 0.05\n            ) +\n  # Add title text\n  draw_label(title_text,\n            x = 0.05, y = 0.945,\n            fontfamily = font_text,\n            size = 7,\n            hjust = 0\n            ) +\n  # Add citation and author text \n  draw_label(tag_text,\n             x = 0.75, y = 0.02,\n             fontfamily = font_text,\n             size = 4,\n             hjust = 0\n  )\n\n# To save   \nggsave(\n  filename = \"streamflow-anomaly-fig.png\",\n  plot = p,\n  width = 4, height = 5,\n  dpi = 300, bg = \"#FAF9F6\"\n)\n```\n:::\n\n\n![](streamflow-anomaly-fig.png)\n",
    "supporting": [
      "flow-anomaly_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}